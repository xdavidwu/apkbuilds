From a9da9228fcdf8f4dd4dd65815ab0aaa1a3fad453 Mon Sep 17 00:00:00 2001
From: Pinghao Wu <xdavidwuph@gmail.com>
Date: Sat, 27 Dec 2025 10:42:35 +0800
Subject: [PATCH] impl renameat2 for musl

---
 src/basic/fs-util.c       | 5 +++++
 src/shared/install-file.c | 5 +++++
 2 files changed, 10 insertions(+)

diff --git a/src/basic/fs-util.c b/src/basic/fs-util.c
index 0c84f42ed6..6d9a956e1e 100644
--- a/src/basic/fs-util.c
+++ b/src/basic/fs-util.c
@@ -3,6 +3,7 @@
 #include <linux/falloc.h>
 #include <stdlib.h>
 #include <sys/file.h>
+#include <sys/syscall.h>
 #include <unistd.h>
 
 #include "alloc-util.h"
@@ -28,6 +29,10 @@
 #include "tmpfile-util.h"
 #include "umask-util.h"
 
+static int renameat2(int __oldfd, const char *__old, int __newfd, const char *__new, unsigned __flags) {
+        return syscall(__NR_renameat2, __oldfd, __old, __newfd, __new, __flags);
+}
+
 int rmdir_parents(const char *path, const char *stop) {
         char *p;
         int r;
diff --git a/src/shared/install-file.c b/src/shared/install-file.c
index c3de84f579..2aa094c473 100644
--- a/src/shared/install-file.c
+++ b/src/shared/install-file.c
@@ -2,6 +2,7 @@
 
 #include <sys/ioctl.h>
 #include <sys/stat.h>
+#include <sys/syscall.h>
 #include <unistd.h>
 
 #include "btrfs-util.h"
@@ -14,6 +15,10 @@
 #include "rm-rf.h"
 #include "sync-util.h"
 
+static int renameat2(int __oldfd, const char *__old, int __newfd, const char *__new, unsigned __flags) {
+        return syscall(__NR_renameat2, __oldfd, __old, __newfd, __new, __flags);
+}
+
 static int fs_make_very_read_only(int fd) {
         struct stat st;
         int r;
-- 
2.52.0

