# Contributor: xdavidwu <xdavidwuph@gmail.com>
# Maintainer: xdavidwu <xdavidwuph@gmail.com>
pkgname=systemd
pkgver=252.4
pkgrel=1
pkgdesc="System and Service Manager"
url="https://www.github.com/systemd/systemd"
arch="all"
license="LGPL2.1-or-later"
# util-linux-login: sulogin for emergency mode
# login: pam support (for systemd-logind)
# fsck: -l used in systemd-fsck
depends="cmd:agetty util-linux-login cmd:fsck mount"
makedepends="coreutils py3-jinja2 gperf libcap-dev util-linux-dev gettext-dev kmod-dev bash libxslt docbook-xsl meson linux-pam-dev zstd-dev libseccomp-dev gnu-efi-dev"
checkdepends=""
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-bash-completion $pkgname-zsh-completion"
source="$pkgname-$pkgver.tar.gz::https://github.com/systemd/systemd-stable/archive/refs/tags/v$pkgver.tar.gz
	0001-errno-util-Make-STRERROR-portable-for-musl.patch
	0001-test-bus-error-strerror-is-assumed-to-be-GNU-specifi.patch
	0001-Adjust-for-musl-headers.patch
	0001-pass-correct-parameters-to-getdents64.patch
	0002-Add-sys-stat.h-for-S_IFDIR.patch
	0003-missing_type.h-add-comparison_fn_t.patch
	0004-add-fallback-parse_printf_format-implementation.patch
	0005-src-basic-missing.h-check-for-missing-strndupa.patch
	0007-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
	0008-add-missing-FTW_-macros-for-musl.patch
	0010-Use-uintmax_t-for-handling-rlim_t.patch
	0011-test-sizeof.c-Disable-tests-for-missing-typedefs-in-.patch
	0014-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
	0015-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
	0018-avoid-redefinition-of-prctl_mm_map-structure.patch
	0022-do-not-disable-buffer-in-writing-files.patch	
	0025-Handle-__cpu_mask-usage.patch
	0026-Handle-missing-gshadow.patch
	0100-Do-not-buffer-on-systemd-sleep.patch
	0101-efi-do-not-set-wide-exec-charset.patch
	0102-bootctl-include-bits-reg.h-for-musl-__WORD_SIZE.patch"
pkgusers="systemd-network systemd-resolve systemd-coredump"
pkggroups="systemd-journal"
provides="hwids-udev=99999999 eudev=99 eudev-libs=99"
builddir="$srcdir/systemd-stable-$pkgver"

build() {
	env LDFLAGS=" -lintl " CFLAGS=" -D__UAPI_DEF_ETHHDR=0 " meson \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--buildtype=plain \
		-Defi=true \
		-Dgnu-efi=true \
		-Duserdb=false \
		-Dman=true \
		-Dpolkit=false \
		-Dkmod=true \
		-Dpam=true \
		-Drepart=false \
		-Dhomed=false \
		-Dremote=false \
		-Dnss-mymachines=false \
		-Dnss-resolve=false \
		-Dimportd=false \
		-Dhtml=false \
		-Ddns-over-tls=false \
		-Dseccomp=true \
		-Dselinux=false \
		-Dapparmor=false \
		-Dacl=false \
		-Daudit=false \
		-Dblkid=true \
		-Dfdisk=false \
		-Dpwquality=false \
		-Dmicrohttpd=false \
		-Dlibcryptsetup=false \
		-Dlibcryptsetup-plugins=false \
		-Dlibcurl=false \
		-Dlibidn2=false \
		-Dlibidn=false \
		-Dlibiptc=false \
		-Dqrencode=false \
		-Dgcrypt=false \
		-Dgnutls=false \
		-Dopenssl=false \
		-Dp11kit=false \
		-Dlibfido2=false \
		-Dtpm2=false \
		-Delfutils=false \
		-Dzlib=false \
		-Dbzip2=false \
		-Dxz=false \
		-Dlz4=false \
		-Dzstd=true \
		-Dxkbcommon=false \
		-Dpcre2=false \
		-Dglib=false \
		-Ddbus=false \
		-Dbpf-framework=false \
		-Dinitrd=false \
		-Dnscd=false \
		-Dutmp=false \
		-Dhibernate=false \
		-Dldconfig=false \
		-Denvironment-d=false \
		-Dbinfmt=false \
		-Dpstore=false \
		-Doomd=false \
		-Dhostnamed=false \
		-Dlocaled=false \
		-Dmachined=false \
		-Dportabled=false \
		-Dsysext=false \
		-Dtimedated=false \
		-Dtimesyncd=false \
		-Dnss-myhostname=false \
		-Dnss-systemd=false \
		-Dfirstboot=false \
		-Drandomseed=false \
		-Dquotacheck=false \
		-Dsysusers=false \
		-Dtmpfiles=false \
		-Dtranslations=false \
		-Dgshadow=false \
		-Dsmack=false \
		-Dima=false \
		-Didn=false \
		-Dkernel-install=false \
		-Dmode=release \
		-Dsysvinit-path='' \
		-Dsysvrcnd-path='' \
		. output
	meson compile ${JOBS:+-j ${JOBS}} -C output
}

check() {
	# Replace with proper check command(s)
	:
}

package() {
	env DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

sha512sums="
d4e99a67c59091dae78f654433a6c5e114ae66256b72d9d43292c43a986ee6a58e2d06f12866cbd7ec821b61580ec003af1725f60fd4b038b4a981b3ca839ee2  systemd-252.4.tar.gz
330545677b4830bde1dfe50fc983ae512333538ff4c1770fa26818c023dfb990b811cec62769dcb0d2cc156a63fb7a03266c1308171c40f379b12b03362539e7  0001-errno-util-Make-STRERROR-portable-for-musl.patch
29020a4f0741f2695280eab80bdf786c92dc2e024cca9c9efcb36ae1611cc267ac93663df97894e2d9142520e79320ab006fe0f53d49230479b579c7bed148d1  0001-test-bus-error-strerror-is-assumed-to-be-GNU-specifi.patch
193e83f04d61d308c37ecfcace60abb34763f7e8b470e117d965b81864f6a67b6cd41eca2fe3baeb3b8ba6d48eae83bd1fd0554847a240892a21f1bc4a94063f  0001-Adjust-for-musl-headers.patch
ac874fd9352460005d0a4b5aec04b92943d7a16621946e240eff56e74fc4b15924179889950d8c4b94f541ad7df6d2b670d5a407e2e52b05b3ea2c2464bc4efb  0001-pass-correct-parameters-to-getdents64.patch
648f15fabd596de697091dffee68d084ce676ff5f9a3a0ec943a59ec7794411fd8d025e779813320ddb3d2a7290a6371ea74bfc28a26a40cc9f3f90ff18031b2  0002-Add-sys-stat.h-for-S_IFDIR.patch
2d64820616f8e90a36db93b8e4d070a3ebb14f30c479bf3d91657ee813dde540dc6de8d416d934835b8845f03fb87004e1004eaf9c31a006abd7114ec9156010  0003-missing_type.h-add-comparison_fn_t.patch
0554da1ca7da24faaba82e26a921f42f45d728da2444f1aa0d700fa96fd69820bf8ea6b06d23fa3129b224d87d141c8de46ea9671a287e85fea22edf08131aec  0004-add-fallback-parse_printf_format-implementation.patch
ba22eb479997a893823cc728897f9796cfe163316449e34c6cf9b516a1d809378a52f90bbf84036f151afb77d315db38210c3e09de9bd5e80eaa04d66e1ecff5  0005-src-basic-missing.h-check-for-missing-strndupa.patch
c56eaa1e14d0fa560eeab47de837030fcdd270cc3a6b7144a0c676495e37a55a9d18e3b2cdaac874506b6c235c5a61b26ccb5bf97ac17ed02a353e33d3f03064  0007-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
a34206eec8fc97eb3469a13b4531cee3c9e2ed170954e748db4dc53643c641b69dfede4c4ce36f440040beb36f6e091f01116335117be82353c94af8e5f8cd1f  0008-add-missing-FTW_-macros-for-musl.patch
9ce4709bb4857f4e46512b7e8df7faa57671ce8d470836e23af7770f3af57320e683359e969ec12657fef05518eb74b13fd8dbfc7182ad2a312b33cb7b8987a5  0010-Use-uintmax_t-for-handling-rlim_t.patch
0f02d7fd4c92bc94e616837aac25a7c06ebff1b45e3f726cf4cd0d07db670a2502cb4345304d4c47b99024d75220c3df2c8a8c94ba1d769ecbb2ebf247ef10de  0011-test-sizeof.c-Disable-tests-for-missing-typedefs-in-.patch
b66c0a5bf0232e2f80bdc8ea03b7ab4608285451907e559331cc000e13e934ea29a6bad7dd16ec25441753aca46b2c1f79d5362cf12c34dc3b2d2c5eb50a4b26  0014-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
5fe1d0a36fbb2f64884c9bfd907894c48a5ec237b64d98867bd9d1dc15205334032d546a02b2f0d77f649f25fcea0a89d18137ddfb3d20bad4b6cdd5ebf691b5  0015-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
6556a44bf013cfa37b68faec39387907bcb601f316bc056b99b8bb26c15ff373f2214fce343aa44401981837c7401bc4c5aa564d3f4321277bdd65f2e4ba5228  0018-avoid-redefinition-of-prctl_mm_map-structure.patch
c079dffc11b772bd4be4f09cc1b61d119133f26b2600e9ed386d5d8e985c30922850c5134aa4c2945a3aaaf89bdff7f37e81bab1fc9eb258d2f13e0b020882fd  0022-do-not-disable-buffer-in-writing-files.patch
5b07b3375846ac09102391a1631c98ea5f75b8a62bf70e589b7d66813a088d397f10ffc493ba0d7365b6a315ae54e4db2a00819ad11d40341f4a3925a00b624b  0025-Handle-__cpu_mask-usage.patch
e9d3de0055ed19b46dbf448306546533f3bc5e5e14d557c02a491aec371d71734c89868c0dfb27332222c659c254549f7163847ccbde15df12043bd4652b1732  0026-Handle-missing-gshadow.patch
aeca4851d4cef2439eca2519dd031a842d7699782edee06239ca66f157711faf16c2943b310963faaf06d3b8c02bb0390b900ea8900c88e5ecbfc000f7929ab6  0100-Do-not-buffer-on-systemd-sleep.patch
daf52c1f16fc29688e45d9bdbc67dff93bb606da3ef95963e3bcbf79690527e6704b8dffc50886342dc213154a62650ee70533dd70e58d6fd6238c17d8aa6e43  0101-efi-do-not-set-wide-exec-charset.patch
22e2dd208002d296f29cdc06b0d57297de28b3166904bdebffba823dbd88650a54a1e96df056f73d444e318f46a2dd1727766f57a99ad5650d985cd24d9f9899  0102-bootctl-include-bits-reg.h-for-musl-__WORD_SIZE.patch
"
