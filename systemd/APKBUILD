# Contributor: xdavidwu <xdavidwuph@gmail.com>
# Maintainer: xdavidwu <xdavidwuph@gmail.com>
pkgname=systemd
pkgver=256.5
pkgrel=1
pkgdesc="System and Service Manager"
url="https://www.github.com/systemd/systemd"
arch="all"
license="LGPL2.1-or-later"
# util-linux-login: sulogin for emergency mode
# login: pam support (for systemd-logind)
# fsck: -l used in systemd-fsck
depends="cmd:agetty util-linux-login cmd:fsck mount cmd:loadkeys"
makedepends="coreutils py3-jinja2 gperf libcap-dev util-linux-dev gettext-dev kmod-dev bash libxslt docbook-xsl meson linux-pam-dev zstd-dev libseccomp-dev py3-elftools"
checkdepends=""
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-bash-completion $pkgname-zsh-completion"
source="$pkgname-$pkgver.tar.gz::https://github.com/systemd/systemd/archive/refs/tags/v$pkgver.tar.gz
	0004-missing_type.h-add-comparison_fn_t.patch
	0005-add-fallback-parse_printf_format-implementation.patch
	0006-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
	0007-add-missing-FTW_-macros-for-musl.patch
	0008-Use-uintmax_t-for-handling-rlim_t.patch
	0009-don-t-pass-AT_SYMLINK_NOFOLLOW-flag-to-faccessat.patch
	0010-Define-glibc-compatible-basename-for-non-glibc-syste.patch
	0011-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
	0012-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
	0013-avoid-redefinition-of-prctl_mm_map-structure.patch
	0014-do-not-disable-buffer-in-writing-files.patch
	0015-Handle-__cpu_mask-usage.patch
	0016-Handle-missing-gshadow.patch
	0017-missing_syscall.h-Define-MIPS-ABI-defines-for-musl.patch
	0018-pass-correct-parameters-to-getdents64.patch
	0019-Adjust-for-musl-headers.patch
	0020-test-bus-error-strerror-is-assumed-to-be-GNU-specifi.patch
	0021-errno-util-Make-STRERROR-portable-for-musl.patch
	0022-sd-event-Make-malloc_trim-conditional-on-glibc.patch
	0023-shared-Do-not-use-malloc_info-on-musl.patch
	0024-avoid-missing-LOCK_EX-declaration.patch
	0025-include-signal.h-to-avoid-the-undeclared-error.patch
	0026-undef-stdin-for-references-using-stdin-as-a-struct-m.patch
	0027-adjust-header-inclusion-order-to-avoid-redeclaration.patch
	0028-build-path.c-avoid-boot-time-segfault-for-musl.patch
	0100-Do-not-buffer-on-systemd-sleep.patch
	0101-efi-do-not-set-wide-exec-charset.patch
	0102-efi-hack-out-musl-wchar-definition.patch
	0103-meson-lintl-for-musl-gettext.patch
	0104-DNM-alpine-path-util-support-pre-usrmerge.patch"
pkgusers="systemd-network systemd-resolve systemd-coredump"
pkggroups="systemd-journal"
provides="hwids-udev=99999999 eudev=99 eudev-libs=99"

build() {
	env CFLAGS=" -D__UAPI_DEF_ETHHDR=0 " meson \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--buildtype=plain \
		-Dauto_features=disabled \
		-Dbootloader=true \
		-Defi=true \
		-Duserdb=false \
		-Dman=true \
		-Dkmod=true \
		-Dpam=true \
		-Ddns-over-tls=false \
		-Dseccomp=true \
		-Dblkid=true \
		-Dtpm=false \
		-Dzstd=true \
		-Dinitrd=false \
		-Dnscd=false \
		-Dutmp=false \
		-Dhibernate=false \
		-Dldconfig=false \
		-Denvironment-d=false \
		-Dbinfmt=false \
		-Dpstore=false \
		-Doomd=false \
		-Dhostnamed=false \
		-Dlocaled=false \
		-Dmachined=false \
		-Dportabled=false \
		-Dsysext=false \
		-Dtimedated=false \
		-Dtimesyncd=false \
		-Dnss-myhostname=false \
		-Dnss-systemd=false \
		-Dfirstboot=false \
		-Drandomseed=false \
		-Dquotacheck=false \
		-Dsysusers=false \
		-Dtmpfiles=false \
		-Dtranslations=false \
		-Dgshadow=false \
		-Dsmack=false \
		-Dima=false \
		-Didn=false \
		-Dkernel-install=false \
		-Dxdg-autostart=false \
		-Dmode=release \
		-Dsysvinit-path='' \
		-Dsysvrcnd-path='' \
		-Ddebug-shell=/bin/sh \
		-Ddefault-user-shell=/bin/sh \
		-Dstoragetm=false \
		. output
	meson compile ${JOBS:+-j ${JOBS}} -C output
}

check() {
	# Replace with proper check command(s)
	:
}

package() {
	env DESTDIR="$pkgdir" meson install --no-rebuild -C output
	ln -s libsystemd.pc "$pkgdir"/usr/lib/pkgconfig/libelogind.pc
	install -d "$pkgdir/sbin"
	ln -s ../usr/lib/systemd/systemd "$pkgdir"/sbin/init
	install -d "$pkgdir/lib"
	ln -s ../usr/lib/udev "$pkgdir"/lib/udev
}

dev() {
	provides="elogind-dev eudev-dev"
	default_dev
}

sha512sums="
40558194e05a17b218adf3d6df48b738c866855d43d09c1e9381c2c568a44a8f1617b64476736fc7e34416ad9e8d25dc023cf9de090b4ef9079866919377009f  systemd-256.5.tar.gz
8c49e9bd1f98a08c536fada241c0eea556a9c0fd2ed52ffc23e39663cf94e53ec6a8539f4dba0d193542341932063a6a8b7fe63ed4636ae35c517355f9163f19  0004-missing_type.h-add-comparison_fn_t.patch
47c709c3420673fe64921f0ceb8c6fb12b8d1b836dfd3f09ee80b8628debb77071851fc5957f30246895a4416b8684ec704c27acf332939e3b5686fa693af5ba  0005-add-fallback-parse_printf_format-implementation.patch
84e1f974f26d97e7cb12562496fee68480a7cc8683d352ade72e0d1d6739b9755fad1e81fc097b05368e6ab4762892d1afaac20ea366ee4f6b859b0f60492c88  0006-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
1d81b848dcfe29f30871e871fa1fa8a495a3b76108355723d85c44adc4dd1900464ebd5fc9b9dda1d2bb818f4d351d591f4335f47036882f1ce1709ecbcb80ed  0007-add-missing-FTW_-macros-for-musl.patch
31233b22f7ca7cef9d7be1946b3ebefe7116aa96f549a1812ceadee535649bf15725e48551dfd9416eeb98436af42ad98132a818793f3b99b4f93cc8ac42a02f  0008-Use-uintmax_t-for-handling-rlim_t.patch
8ac89bab45cef2a958abd65d5ba9adb31b4a3da1abde0a699ea0926024a80530f8329a9b4deafb0c01a146ca6a74dc9b6d523495590f8495c89dc76fb9d3b961  0009-don-t-pass-AT_SYMLINK_NOFOLLOW-flag-to-faccessat.patch
f73d3101ed69d966366181b14e9f7fabf02dd984398256650799e6a19260e18efc9b120ba3fe33655b5468e67d501c0ee0f03fe318350956cd0bf7cac70035b1  0010-Define-glibc-compatible-basename-for-non-glibc-syste.patch
500d772d8db50fba5d47eb40ad0002036eb963ec4101f61175e49515f33c3fb9a421f02b48a266e8c328a4b29a06870dfed8334f3bb0e038afd0f87067ba626f  0011-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
4d7829249e1a14261a5950a09dc4c84914cc8779720aaefd3064a7e1c2e271fb456511a0f1c5cf8b2a0c26e39f8107eba0c7808c4802f7941c03935ae02f2dc2  0012-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
ad6438c062e1d3840cf9eaf34684f9a8443e5552bf0518a36d8cbd17ee28328d1876de28b21b96bba0978a1867dd93e4458dd8dcb5d19f946bab14e4d88a29fb  0013-avoid-redefinition-of-prctl_mm_map-structure.patch
9b5ce75f909ca1f3c189d715d9af945ce3099393ad99da0ec81c948de61e076cba89439eaba001bd7fc827f0385159fd79d3ff5889f3aeef9ebfe49de0ec1210  0014-do-not-disable-buffer-in-writing-files.patch
5a5b5ace349d9dd9b06096573c44275d8f49209edcaff64e48f3eb5d96ab651ca1384860e0ae4db6da104e0a1b8b2d47d504e87355548f87030bf03acb4a47f1  0015-Handle-__cpu_mask-usage.patch
9b80f17838e87ff8230cfb2b1f08c28112231af2961e60162674938f298c2f4d85085ac35f44d1655e34ccc716946352e7fa258be3e35f66b28c358ae02483b5  0016-Handle-missing-gshadow.patch
aa0ec779c158f782802b98da96c997d034112990140fb72883de1eb37b87048a7ee63a69e1a0ddac198d5ecd279aca5dc4b9c91c4ff90da3cbf8cc67ef72f27a  0017-missing_syscall.h-Define-MIPS-ABI-defines-for-musl.patch
2fec0244271fa5c79b16031a12079a47162b8f2611a7ccc7cf631fa003809dcbb0d4b3e2bf23e6f9ec3db380bf9e70011b17dc16dcab0c4900e0138e3c1ecbc2  0018-pass-correct-parameters-to-getdents64.patch
4cf905b4c5caa03816af3a4befe06deb7d3270bf14eed649b5e8415b3a840dc16e292a7d812a45c346f0de30996380ef97432894f8badacf3aa55d2fd8f16491  0019-Adjust-for-musl-headers.patch
af26d46af5ab4596d113b92c2a170ea75d7095694b341f5f283fc48981237a4e97c09355f432fe26507240cc6bb2e62bf69be4d87eeb44b8d002d581cc2abf63  0020-test-bus-error-strerror-is-assumed-to-be-GNU-specifi.patch
58c3d593fad7b834c95d91b5facc0a831bc1ad4a7b962e56d9d4e124b7ab0b98330f939e54d525ff6529905540fe8f5111637e5b22b03760bd8962ced86f751b  0021-errno-util-Make-STRERROR-portable-for-musl.patch
b931d5916349534154bfd82eddad80a3d6b0ffe2c31e11934d6cc7f1db80263d697731064f28748883e84994e3fc07f9e86aa329cb90f04ee492d66220aeaffd  0022-sd-event-Make-malloc_trim-conditional-on-glibc.patch
a494bbc2852c516cdb41cb7e412ec65180544298469b27782483c50bdd4b4193ab886046c0803c651d0a5a6571c1b5737c7ff6ea7e251b76b223a2c7f8318892  0023-shared-Do-not-use-malloc_info-on-musl.patch
133801b668da725259426ddd893c20aa6a66e2beb3edb896a62d95ffb0e667cdbf68101a89102e8aceb61c50105b044178bd970c16a7a4139f336c5159b0f924  0024-avoid-missing-LOCK_EX-declaration.patch
0881dc9c854734689d8b83bd5680d7863af721ddb7cbcd157cdf26c5daf7c2f3cd870736785ad86e9b62e1c6c8c2b1dd9c5a30b1afdff2a826cf9cd5d1e9dfad  0025-include-signal.h-to-avoid-the-undeclared-error.patch
ab39b15c5b2216db65f60300c2246182b51c9da529e35991cdd6c350602c8012c505788483294b4696738b1ad8377556325d4b595c79d2c03981d8336a75390c  0026-undef-stdin-for-references-using-stdin-as-a-struct-m.patch
c32cc25479e251c5293e80499d96ab437bddf9a55329c74675f96f4cfac1244b1637faddd6427e3229491e8eb6e037686fc7d94a155247894183c6f4b1a212e1  0027-adjust-header-inclusion-order-to-avoid-redeclaration.patch
4c6ef1b0811cfcd403a9aaa60f14aaa1704b675592c0f49ad4c8215fc9415a3d0b36528a9cf338965c6dec9c41d3e4c580bf70151dca5a63dca2665c189967a5  0028-build-path.c-avoid-boot-time-segfault-for-musl.patch
09ffd63addf1ae060ce617695b587963da6c1300595b01f8edc5ee4c4d4182f6ef909f2b07489f6fb9e3cbdad73dfb57dc932722c7422e1596b68327d7da3769  0100-Do-not-buffer-on-systemd-sleep.patch
4ea51f1b47140ee79d738fa983c42402ed0bb4c5ae79880fd30555c7571b5e0a4e7e86457be987bfdf0da928a1111a54709ed54a6676305e5036920347adb5cd  0101-efi-do-not-set-wide-exec-charset.patch
ab3075a07010708fa795a9ff2a0f08f9a0a317034479e41bc8948c0d24155087b797b832e13dc6f534151600dbe5ad4526e9a48eec0328fc00c6609a8328aee7  0102-efi-hack-out-musl-wchar-definition.patch
ec8feed6259e52874ff8c3019746a6c40d38cc4b5a775d934161c51515f435768baad7d87315ecf8192266d2a5e096137a73c8bbe2f8f88b6844e53c276cfdd1  0103-meson-lintl-for-musl-gettext.patch
d70800a1e7ce4de3a297420ddb9071f3ea68eb5bc87a0f17f06557556b4b0467fc3afaa6eebe8c0553cc8860327455e17e5a25d27b27abc46ac45062ea168201  0104-DNM-alpine-path-util-support-pre-usrmerge.patch
"
