# Contributor: xdavidwu <xdavidwuph@gmail.com>
# Maintainer: xdavidwu <xdavidwuph@gmail.com>
pkgname=systemd
pkgver=253.4
pkgrel=0
pkgdesc="System and Service Manager"
url="https://www.github.com/systemd/systemd"
arch="all"
license="LGPL2.1-or-later"
# util-linux-login: sulogin for emergency mode
# login: pam support (for systemd-logind)
# fsck: -l used in systemd-fsck
depends="cmd:agetty util-linux-login cmd:fsck mount"
makedepends="coreutils py3-jinja2 gperf libcap-dev util-linux-dev gettext-dev kmod-dev bash libxslt docbook-xsl meson linux-pam-dev zstd-dev libseccomp-dev gnu-efi-dev"
checkdepends=""
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-bash-completion $pkgname-zsh-completion"
source="$pkgname-$pkgver.tar.gz::https://github.com/systemd/systemd-stable/archive/refs/tags/v$pkgver.tar.gz
	0001-Adjust-for-musl-headers.patch
	0003-errno-util-Make-STRERROR-portable-for-musl.patch
	0005-pass-correct-parameters-to-getdents64.patch
	0006-test-bus-error-strerror-is-assumed-to-be-GNU-specifi.patch
	0007-Add-sys-stat.h-for-S_IFDIR.patch
	0009-missing_type.h-add-comparison_fn_t.patch
	0010-add-fallback-parse_printf_format-implementation.patch
	0011-src-basic-missing.h-check-for-missing-strndupa.patch
	0012-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
	0013-add-missing-FTW_-macros-for-musl.patch
	0014-Use-uintmax_t-for-handling-rlim_t.patch
	0015-test-sizeof.c-Disable-tests-for-missing-typedefs-in-.patch
	0018-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
	0019-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
	0020-avoid-redefinition-of-prctl_mm_map-structure.patch
	0021-do-not-disable-buffer-in-writing-files.patch
	0022-Handle-__cpu_mask-usage.patch
	0023-Handle-missing-gshadow.patch
	0026-src-boot-efi-efi-string.c-define-wchar_t-from-__WCHA.patch
	0100-Do-not-buffer-on-systemd-sleep.patch
	0101-efi-do-not-set-wide-exec-charset.patch"
pkgusers="systemd-network systemd-resolve systemd-coredump"
pkggroups="systemd-journal"
provides="hwids-udev=99999999 eudev=99 eudev-libs=99"
builddir="$srcdir/systemd-stable-$pkgver"

build() {
	env LDFLAGS=" -lintl " CFLAGS=" -D__UAPI_DEF_ETHHDR=0 " meson \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--buildtype=plain \
		-Defi=true \
		-Dgnu-efi=true \
		-Duserdb=false \
		-Dman=true \
		-Dpolkit=false \
		-Dkmod=true \
		-Dpam=true \
		-Drepart=false \
		-Dhomed=false \
		-Dremote=false \
		-Dnss-mymachines=false \
		-Dnss-resolve=false \
		-Dimportd=false \
		-Dhtml=false \
		-Ddns-over-tls=false \
		-Dseccomp=true \
		-Dselinux=false \
		-Dapparmor=false \
		-Dacl=false \
		-Daudit=false \
		-Dblkid=true \
		-Dfdisk=false \
		-Dpwquality=false \
		-Dmicrohttpd=false \
		-Dlibcryptsetup=false \
		-Dlibcryptsetup-plugins=false \
		-Dlibcurl=false \
		-Dlibidn2=false \
		-Dlibidn=false \
		-Dlibiptc=false \
		-Dqrencode=false \
		-Dgcrypt=false \
		-Dgnutls=false \
		-Dopenssl=false \
		-Dp11kit=false \
		-Dlibfido2=false \
		-Dtpm2=false \
		-Delfutils=false \
		-Dzlib=false \
		-Dbzip2=false \
		-Dxz=false \
		-Dlz4=false \
		-Dzstd=true \
		-Dxkbcommon=false \
		-Dpcre2=false \
		-Dglib=false \
		-Ddbus=false \
		-Dbpf-framework=false \
		-Dinitrd=false \
		-Dnscd=false \
		-Dutmp=false \
		-Dhibernate=false \
		-Dldconfig=false \
		-Denvironment-d=false \
		-Dbinfmt=false \
		-Dpstore=false \
		-Doomd=false \
		-Dhostnamed=false \
		-Dlocaled=false \
		-Dmachined=false \
		-Dportabled=false \
		-Dsysext=false \
		-Dtimedated=false \
		-Dtimesyncd=false \
		-Dnss-myhostname=false \
		-Dnss-systemd=false \
		-Dfirstboot=false \
		-Drandomseed=false \
		-Dquotacheck=false \
		-Dsysusers=false \
		-Dtmpfiles=false \
		-Dtranslations=false \
		-Dgshadow=false \
		-Dsmack=false \
		-Dima=false \
		-Didn=false \
		-Dkernel-install=false \
		-Dmode=release \
		-Dsysvinit-path='' \
		-Dsysvrcnd-path='' \
		. output
	meson compile ${JOBS:+-j ${JOBS}} -C output
}

check() {
	# Replace with proper check command(s)
	:
}

package() {
	env DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

sha512sums="
cbd572330871fe938307cdead57637e9a03fcdb95b62dd12506f13f48fddcacfaf1e7b179bc9e1c1889a07d3bf21f840aafc773df3a1ab05b37d28950cb94ee1  systemd-253.4.tar.gz
365360cc6b7591152fd8043eb1173c239b9b0290e4f7f5c52e60213e75997034e1e62d3e03187420e1b5e003881f2d748a5dda18b9e7d13e7c97a2caf942ed8c  0001-Adjust-for-musl-headers.patch
13cf635d49fb0c91c7d2fc672095a836cdad22dff828b49518dcbbb6669d1fdf1f228c525f7d85daa40e8e75a80d64161449ffbf6149fda89f38189a2b7160df  0003-errno-util-Make-STRERROR-portable-for-musl.patch
c7c92dd6e98c0960fb6744b78ef60df1cd33e6ac71cce02146b656c795fc181d8e20609381d0bae07d95716e3eb8bed9aa1185494cfe074cfa2b67fcdf4f4940  0005-pass-correct-parameters-to-getdents64.patch
d6cd00693af5c905ab17764e45825eb5a8c23f727b9296efa0603207f48debe6f4a376681517d7558c7ec8c75ea6dd7b436637106e0d06d103dc289d6ddbdd33  0006-test-bus-error-strerror-is-assumed-to-be-GNU-specifi.patch
6772fcf6daab52ae0d236dba5b01ef56b248b5788d8164e74976db87ad4d1ba4d45d82163038b4a0e0e2b753f1c33d3b897309948e3d899ff21d6603a1921e3b  0007-Add-sys-stat.h-for-S_IFDIR.patch
548b77c617eafa0b9b64173b814e6d2304049ab31dc8ee64e3c5a0526ecf2c5e860b774d62de3c09afd6a59ebf99ea8ca279a767f4f2cd9cf4c6f83c0da312ef  0009-missing_type.h-add-comparison_fn_t.patch
4a7cffce1d15a60c92d7413afba874277a02424e4c55e193cfc2a602881e6df8f9f75ef74351202f13e681b3d8a93068d0b7f1cb742fe98bc9d7e5404121ef99  0010-add-fallback-parse_printf_format-implementation.patch
18d7e55eb61b1ee3a1815016abb6efaa964ad71ca97c6787b3dd2c5871fdd1f4195b4759122963779d71b23ef3923158c9b5d995cc45a74023eefcb006d5e876  0011-src-basic-missing.h-check-for-missing-strndupa.patch
cd762512c9b780b6c92407202f375027586f925dae608ac820727f0ef837d9b15fd236f714635fb6b4eca9a6ccac4f5fc0357769179dddcd6d3f86bf580968bc  0012-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
2cec9f3e7fe5046862a769281e271b341a5e8a856f3aed982222c63ee20e1640b70a27a1b0d669d5e2fe7a5b8ec72d5b1a8fc77bd124690fa58cf5264cae7f57  0013-add-missing-FTW_-macros-for-musl.patch
cfbad07007889860fa3e11580ca4265cb7b2898b83367eba103c4ec1df62148a0fbcfc2a8cf48428b26db9fd51f051bb82c1f212593e1aee230410ed62aa4fd3  0014-Use-uintmax_t-for-handling-rlim_t.patch
98a21553865cb3d74635297e5964cc122a32aa32c7e6ab208b9093117a3df3720067b9182258229761a2efbca517756dc68e24be1ed1e5419bbe230a67025624  0015-test-sizeof.c-Disable-tests-for-missing-typedefs-in-.patch
d8c54ea44440ba7723e26569e29ab2a36c5d2b57f21971a01d31d1cd76d27bd0968abdd1665d2427d59c6a1c130f74f53a15a5ba2b31383414b88d526d397fdf  0018-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
e035b7b578431c7bbf4ab818066b7f950ffb2de706213150cb74a337d607a745f94dd229047e1f4c10a46f943dd198e4358e60c6df03131d46af3a9f2f477551  0019-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
6d6bb36c5d600653284ebdd1e0417e3e4e6b00e4e8b9d79fa58ceb6cf980e5d3def49a6a2d6493470220cf01708f7fa60c7cdc07b768aca312cbd401e9ff54fb  0020-avoid-redefinition-of-prctl_mm_map-structure.patch
512d402e72c27105901d3e4fbb1fa6ef766814392d85e066c04a4bc8d877a41f883dda2a43165bc121d67c34fd1818ead533207043150383a29bdee44f4efa67  0021-do-not-disable-buffer-in-writing-files.patch
580b691581454dd93f46871512dfb9c26616ef07b290465b52a782b4f2df7211706f8833e64a7efc1274088a8b030eb70ddadd53ccab7e1bb4848955907d0cbf  0022-Handle-__cpu_mask-usage.patch
ec85ce18d9eda9152aa50189aff9e967a9763124558bc7fa4dbb11ab8845cb6802d7a8fe39b438ee983e1a172759ea7dffb38a81521b550f889d08dec2d8cead  0023-Handle-missing-gshadow.patch
57cbca6d78c0d301e62ac91c7792e50a22d8af5ce213505322bded7d09a6210d2d0e804f04113d886820f472be82e91d99e62c086addd869fd0b200e39801419  0026-src-boot-efi-efi-string.c-define-wchar_t-from-__WCHA.patch
aeca4851d4cef2439eca2519dd031a842d7699782edee06239ca66f157711faf16c2943b310963faaf06d3b8c02bb0390b900ea8900c88e5ecbfc000f7929ab6  0100-Do-not-buffer-on-systemd-sleep.patch
daf52c1f16fc29688e45d9bdbc67dff93bb606da3ef95963e3bcbf79690527e6704b8dffc50886342dc213154a62650ee70533dd70e58d6fd6238c17d8aa6e43  0101-efi-do-not-set-wide-exec-charset.patch
"
