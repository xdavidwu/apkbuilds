# Contributor: xdavidwu <xdavidwuph@gmail.com>
# Maintainer: xdavidwu <xdavidwuph@gmail.com>
pkgname=systemd
pkgver=254
pkgrel=1
pkgdesc="System and Service Manager"
url="https://www.github.com/systemd/systemd"
arch="all"
license="LGPL2.1-or-later"
# util-linux-login: sulogin for emergency mode
# login: pam support (for systemd-logind)
# fsck: -l used in systemd-fsck
depends="cmd:agetty util-linux-login cmd:fsck mount cmd:loadkeys"
makedepends="coreutils py3-jinja2 gperf libcap-dev util-linux-dev gettext-dev kmod-dev bash libxslt docbook-xsl meson linux-pam-dev zstd-dev libseccomp-dev gnu-efi-dev"
checkdepends=""
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-bash-completion $pkgname-zsh-completion"
source="$pkgname-$pkgver.tar.gz::https://github.com/systemd/systemd-stable/archive/refs/tags/v$pkgver.tar.gz
	0001-Adjust-for-musl-headers.patch
	0003-errno-util-Make-STRERROR-portable-for-musl.patch
	0005-pass-correct-parameters-to-getdents64.patch
	0006-test-bus-error-strerror-is-assumed-to-be-GNU-specifi.patch
	0007-Add-sys-stat.h-for-S_IFDIR.patch
	0009-missing_type.h-add-comparison_fn_t.patch
	0010-add-fallback-parse_printf_format-implementation.patch
	0011-src-basic-missing.h-check-for-missing-strndupa.patch
	0012-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
	0013-add-missing-FTW_-macros-for-musl.patch
	0014-Use-uintmax_t-for-handling-rlim_t.patch
	0018-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
	0019-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
	0020-avoid-redefinition-of-prctl_mm_map-structure.patch
	0021-do-not-disable-buffer-in-writing-files.patch
	0022-Handle-__cpu_mask-usage.patch
	0023-Handle-missing-gshadow.patch
	0025-include-sys-file.h-for-LOCK_EX.patch
	0026-test-test-sizeof-Include-sys-timex.h-for-struct-time.patch
	0027-include-missing-sys-file.h-for-LOCK_EX.patch
	0028-sd-event-Make-malloc_trim-conditional-on-glibc.patch
	0029-shared-Do-not-use-malloc_info-on-musl.patch
	0100-Do-not-buffer-on-systemd-sleep.patch
	0101-efi-do-not-set-wide-exec-charset.patch"
pkgusers="systemd-network systemd-resolve systemd-coredump"
pkggroups="systemd-journal"
provides="hwids-udev=99999999 eudev=99 eudev-libs=99"
builddir="$srcdir/systemd-stable-$pkgver"

build() {
	env LDFLAGS=" -lintl " CFLAGS=" -D__UAPI_DEF_ETHHDR=0 " meson \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--buildtype=plain \
		-Defi=true \
		-Duserdb=false \
		-Dman=true \
		-Dpolkit=false \
		-Dkmod=true \
		-Dpam=true \
		-Drepart=false \
		-Dhomed=false \
		-Dremote=false \
		-Dnss-mymachines=false \
		-Dnss-resolve=false \
		-Dimportd=false \
		-Dhtml=false \
		-Ddns-over-tls=false \
		-Dseccomp=true \
		-Dselinux=false \
		-Dapparmor=false \
		-Dacl=false \
		-Daudit=false \
		-Dblkid=true \
		-Dfdisk=false \
		-Dpwquality=false \
		-Dmicrohttpd=false \
		-Dlibcryptsetup=false \
		-Dlibcryptsetup-plugins=false \
		-Dlibcurl=false \
		-Dlibidn2=false \
		-Dlibidn=false \
		-Dlibiptc=false \
		-Dqrencode=false \
		-Dgcrypt=false \
		-Dgnutls=false \
		-Dopenssl=false \
		-Dp11kit=false \
		-Dlibfido2=false \
		-Dtpm2=false \
		-Delfutils=false \
		-Dzlib=false \
		-Dbzip2=false \
		-Dxz=false \
		-Dlz4=false \
		-Dzstd=true \
		-Dxkbcommon=false \
		-Dpcre2=false \
		-Dglib=false \
		-Ddbus=false \
		-Dbpf-framework=false \
		-Dinitrd=false \
		-Dnscd=false \
		-Dutmp=false \
		-Dhibernate=false \
		-Dldconfig=false \
		-Denvironment-d=false \
		-Dbinfmt=false \
		-Dpstore=false \
		-Doomd=false \
		-Dhostnamed=false \
		-Dlocaled=false \
		-Dmachined=false \
		-Dportabled=false \
		-Dsysext=false \
		-Dtimedated=false \
		-Dtimesyncd=false \
		-Dnss-myhostname=false \
		-Dnss-systemd=false \
		-Dfirstboot=false \
		-Drandomseed=false \
		-Dquotacheck=false \
		-Dsysusers=false \
		-Dtmpfiles=false \
		-Dtranslations=false \
		-Dgshadow=false \
		-Dsmack=false \
		-Dima=false \
		-Didn=false \
		-Dkernel-install=false \
		-Dmode=release \
		-Dsysvinit-path='' \
		-Dsysvrcnd-path='' \
		. output
	meson compile ${JOBS:+-j ${JOBS}} -C output
}

check() {
	# Replace with proper check command(s)
	:
}

package() {
	env DESTDIR="$pkgdir" meson install --no-rebuild -C output
	ln -s libsystemd.pc "$pkgdir"/usr/lib/pkgconfig/libelogind.pc
}

dev() {
	provides="elogind-dev eudev-dev"
	default_dev
}

sha512sums="
2e9567473d6913483074be5b79090c75dfc965a7afa1b617e18780f3a41787b08ffde0d5cfd115b0b01a84a04a8623db004c7ec29e1c0442c94f7817a4616ad4  systemd-254.tar.gz
365360cc6b7591152fd8043eb1173c239b9b0290e4f7f5c52e60213e75997034e1e62d3e03187420e1b5e003881f2d748a5dda18b9e7d13e7c97a2caf942ed8c  0001-Adjust-for-musl-headers.patch
e27af86219786437f66d9ecfea4996f95608e6d64baf7dcfb3421d40de863abdb2dedc114939b6f05feaec3cb3790c8214f92d5df95ea022d6037fe6d3ff6663  0003-errno-util-Make-STRERROR-portable-for-musl.patch
c7c92dd6e98c0960fb6744b78ef60df1cd33e6ac71cce02146b656c795fc181d8e20609381d0bae07d95716e3eb8bed9aa1185494cfe074cfa2b67fcdf4f4940  0005-pass-correct-parameters-to-getdents64.patch
d6cd00693af5c905ab17764e45825eb5a8c23f727b9296efa0603207f48debe6f4a376681517d7558c7ec8c75ea6dd7b436637106e0d06d103dc289d6ddbdd33  0006-test-bus-error-strerror-is-assumed-to-be-GNU-specifi.patch
6772fcf6daab52ae0d236dba5b01ef56b248b5788d8164e74976db87ad4d1ba4d45d82163038b4a0e0e2b753f1c33d3b897309948e3d899ff21d6603a1921e3b  0007-Add-sys-stat.h-for-S_IFDIR.patch
548b77c617eafa0b9b64173b814e6d2304049ab31dc8ee64e3c5a0526ecf2c5e860b774d62de3c09afd6a59ebf99ea8ca279a767f4f2cd9cf4c6f83c0da312ef  0009-missing_type.h-add-comparison_fn_t.patch
855c7ba93262cd7ec416a990f360cab9d23cfe84618f2fcab426d4d69c90cf5174baabf0670818ef4ef3d9c4dcc10ad772f0f701e1bbab160552dd21eae826c2  0010-add-fallback-parse_printf_format-implementation.patch
2786d086c270781a7584c0239a15e00a2b05f2f3ecbac199881dca7086264dd292afb232b75775a38f5fde0db4841f68ce8d4eab26de796369fd4301e6b65eb0  0011-src-basic-missing.h-check-for-missing-strndupa.patch
4edce319024d49237ccfc34156a3bc1015b4926c52e2117fb13aa1ab8428adde22b60e9016dbd4e59072ff51ace0e29e9db322541735975c26b386c37a2ac8a5  0012-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
2cec9f3e7fe5046862a769281e271b341a5e8a856f3aed982222c63ee20e1640b70a27a1b0d669d5e2fe7a5b8ec72d5b1a8fc77bd124690fa58cf5264cae7f57  0013-add-missing-FTW_-macros-for-musl.patch
51a87daf5e379cdcf9d9c49b445b280883db67d2b5060f165bb245829088d4555e07ce932a4a0a2b398ed665dd1ff455e48a759c84f1fd248d9a3bac8813b142  0014-Use-uintmax_t-for-handling-rlim_t.patch
29bcb246489c4cabca3dab91fa8720227e8489363868ebb777f864b278a83fab1c66564b51bfc7417096e347f5e85920500649fa3a212f58af2529318230b28f  0018-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
088b2fecf8dc9ab7e1806a6f9bbcaca729b2edd9d095fe8ee1390359c856167519229ce7fa9aae9376bff7cc09a612d015ef42499bbcd60bc13ed950d3158907  0019-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
6d6bb36c5d600653284ebdd1e0417e3e4e6b00e4e8b9d79fa58ceb6cf980e5d3def49a6a2d6493470220cf01708f7fa60c7cdc07b768aca312cbd401e9ff54fb  0020-avoid-redefinition-of-prctl_mm_map-structure.patch
b9f2e50da7c6328bbaa547e2ab4bc4bbcc210bd8157b3c828fd252abbbf5b44fd5cd173b6ec3f5cc17371c532fa67809e16d677dbc895e22609765efb5c5ec3a  0021-do-not-disable-buffer-in-writing-files.patch
b25970c4bbe715b44cacc684c3d1efa9f50cf23df6ef7a365b072e1de62b69c23f5db341bee193b0367eda86cd3b288bdec55d9f4ff748d54c39992be4d567df  0022-Handle-__cpu_mask-usage.patch
987318b986efa081627fce402262484fac6e792d55ede8dade88336a0e91c0aa3fcbae9951614407879f8dc5015e71c706a78242889ffeea70081c14d0395bb8  0023-Handle-missing-gshadow.patch
4a011879e78cba8962cb238df064eb03f8007a1c97345fb24e1b01a149a715ce0c7c16c27752d412ae737b7054e99033bf7bad099391f5366fbd4d1f04d2fa74  0025-include-sys-file.h-for-LOCK_EX.patch
462febd7b76f8959fe93518860d7ed90a49f0eb279de1cb3d8b6cc98598f0e8c962ecdb9447753fb8a0476775fb2ed460e462f9b3c0e93738b357c03c48259f2  0026-test-test-sizeof-Include-sys-timex.h-for-struct-time.patch
00eef49f259c4c1a78c6177707ba4464229690c749d580aa96972e2c71a9bc67ea416eadf0c77ec7b8c1e92cdbe04fceadbd3fe9fa5be7d886403d3a1a6cfefe  0027-include-missing-sys-file.h-for-LOCK_EX.patch
d4a5c506dc2378033a4fc15eba510e8cf8bc5642000758dd1b05526ccac8a4ce47c23297e301ec99bdf4a19ce9f84a008b4714cc9e655a596d1aa58de47f683b  0028-sd-event-Make-malloc_trim-conditional-on-glibc.patch
fcee3a9384cb27083b82792a246045b1d1d974ee200fd772661766e9445ea36d8c0c9003527783f2a7958107261ec7fa1b0e0a30200b3e2d0f2ea51657bba166  0029-shared-Do-not-use-malloc_info-on-musl.patch
9737f2d261fca96f0038489e0d3b166de015a76aa8738413afa8a44da6ebb6c9cf55f4642b9b2ddd9000f76880dc9b2b077ac655597b11cdb79ccfb0196190bd  0100-Do-not-buffer-on-systemd-sleep.patch
4ea51f1b47140ee79d738fa983c42402ed0bb4c5ae79880fd30555c7571b5e0a4e7e86457be987bfdf0da928a1111a54709ed54a6676305e5036920347adb5cd  0101-efi-do-not-set-wide-exec-charset.patch
"
