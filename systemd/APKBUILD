# Contributor: xdavidwu <xdavidwuph@gmail.com>
# Maintainer: xdavidwu <xdavidwuph@gmail.com>
pkgname=systemd
pkgver=251.4
pkgrel=0
pkgdesc="System and Service Manager"
url="https://www.github.com/systemd/systemd"
arch="all"
license="LGPL2.1-or-later"
# util-linux-login: sulogin for emergency mode
# login: pam support (for systemd-logind)
# fsck: -l used in systemd-fsck
depends="cmd:agetty util-linux-login cmd:fsck mount"
makedepends="coreutils py3-jinja2 gperf libcap-dev util-linux-dev gettext-dev kmod-dev bash libxslt docbook-xsl meson linux-pam-dev zstd-dev libseccomp-dev gnu-efi-dev"
checkdepends=""
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-bash-completion $pkgname-zsh-completion"
source="$pkgname-$pkgver.tar.gz::https://github.com/systemd/systemd-stable/archive/refs/tags/v$pkgver.tar.gz
	0001-Adjust-for-musl-headers.patch
	0001-pass-correct-parameters-to-getdents64.patch
	0002-Add-sys-stat.h-for-S_IFDIR.patch
	0003-missing_type.h-add-comparison_fn_t.patch
	0004-add-fallback-parse_printf_format-implementation.patch
	0005-src-basic-missing.h-check-for-missing-strndupa.patch
	0007-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
	0008-add-missing-FTW_-macros-for-musl.patch
	0010-Use-uintmax_t-for-handling-rlim_t.patch
	0011-test-sizeof.c-Disable-tests-for-missing-typedefs-in-.patch
	0014-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
	0015-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
	0018-avoid-redefinition-of-prctl_mm_map-structure.patch
	0022-do-not-disable-buffer-in-writing-files.patch	
	0025-Handle-__cpu_mask-usage.patch
	0026-Handle-missing-gshadow.patch
	0100-Do-not-buffer-on-systemd-sleep.patch
	0101-efi-do-not-set-wide-exec-charset.patch"
pkgusers="systemd-network systemd-resolve systemd-coredump"
pkggroups="systemd-journal"
provides="hwids-udev=99999999 eudev=99 eudev-libs=99"
builddir="$srcdir/systemd-stable-$pkgver"

build() {
	env LDFLAGS=" -lintl " CFLAGS=" -D__UAPI_DEF_ETHHDR=0 " meson \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--buildtype=plain \
		-Defi=true \
		-Dgnu-efi=true \
		-Duserdb=false \
		-Dman=true \
		-Dpolkit=false \
		-Dkmod=true \
		-Dpam=true \
		-Drepart=false \
		-Dhomed=false \
		-Dremote=false \
		-Dnss-mymachines=false \
		-Dnss-resolve=false \
		-Dimportd=false \
		-Dhtml=false \
		-Ddns-over-tls=false \
		-Dseccomp=true \
		-Dselinux=false \
		-Dapparmor=false \
		-Dacl=false \
		-Daudit=false \
		-Dblkid=true \
		-Dfdisk=false \
		-Dpwquality=false \
		-Dmicrohttpd=false \
		-Dlibcryptsetup=false \
		-Dlibcryptsetup-plugins=false \
		-Dlibcurl=false \
		-Dlibidn2=false \
		-Dlibidn=false \
		-Dlibiptc=false \
		-Dqrencode=false \
		-Dgcrypt=false \
		-Dgnutls=false \
		-Dopenssl=false \
		-Dp11kit=false \
		-Dlibfido2=false \
		-Dtpm2=false \
		-Delfutils=false \
		-Dzlib=false \
		-Dbzip2=false \
		-Dxz=false \
		-Dlz4=false \
		-Dzstd=true \
		-Dxkbcommon=false \
		-Dpcre2=false \
		-Dglib=false \
		-Ddbus=false \
		-Dbpf-framework=false \
		-Dinitrd=false \
		-Dnscd=false \
		-Dutmp=false \
		-Dhibernate=false \
		-Dldconfig=false \
		-Denvironment-d=false \
		-Dbinfmt=false \
		-Dpstore=false \
		-Doomd=false \
		-Dhostnamed=false \
		-Dlocaled=false \
		-Dmachined=false \
		-Dportabled=false \
		-Dsysext=false \
		-Dtimedated=false \
		-Dtimesyncd=false \
		-Dnss-myhostname=false \
		-Dnss-systemd=false \
		-Dfirstboot=false \
		-Drandomseed=false \
		-Dquotacheck=false \
		-Dsysusers=false \
		-Dtmpfiles=false \
		-Dtranslations=false \
		-Dgshadow=false \
		-Dsmack=false \
		-Dima=false \
		-Didn=false \
		-Dkernel-install=false \
		-Dmode=release \
		-Dsysvinit-path='' \
		-Dsysvrcnd-path='' \
		. output
	meson compile ${JOBS:+-j ${JOBS}} -C output
}

check() {
	# Replace with proper check command(s)
	:
}

package() {
	env DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

sha512sums="
7bbfadd80b88a4c3510a5e4e3572e4eab71dafbf6289da038e552988e09ee8da16da3c9bb8a4fbbde6c6236e0e3c352b0a33f9ee0b84f10241f3499383387738  systemd-251.4.tar.gz
f076304ea23382099c6b96b2f839f5e5b1e5847af3165f2a468fd5f9db605aa12a0a92ed565cefce58a9323eb8b9cac3a823cd2f55523b913bb8fb4fc6d84dff  0001-Adjust-for-musl-headers.patch
ac874fd9352460005d0a4b5aec04b92943d7a16621946e240eff56e74fc4b15924179889950d8c4b94f541ad7df6d2b670d5a407e2e52b05b3ea2c2464bc4efb  0001-pass-correct-parameters-to-getdents64.patch
fba959ab24acead001efe812b0fd64b62be805347050ce997e7ba38c6aae74b9968f88883ec5f7886e38dbd8f4e04c130e726a192bac06d685fb7a2ff9be2a14  0002-Add-sys-stat.h-for-S_IFDIR.patch
2d64820616f8e90a36db93b8e4d070a3ebb14f30c479bf3d91657ee813dde540dc6de8d416d934835b8845f03fb87004e1004eaf9c31a006abd7114ec9156010  0003-missing_type.h-add-comparison_fn_t.patch
830289b7217900ad7ff82c28222919eb1c274389dc906e45b276cb18fec5e73b89529a005265f1850fdb02206985c46f8eb11c998a6b02532455d3f4bec4c114  0004-add-fallback-parse_printf_format-implementation.patch
7e17840b8da71679ee15d22435183dda045d58b450dbcaf917e3acb2c7ef03d9a1e4d27570b6112dc00e28c254a8c49863b76b815957568c9b419f3d6ec1fac6  0005-src-basic-missing.h-check-for-missing-strndupa.patch
c622a3f201c83877c80441e6f38b3ac43ef231003dfc214294bb25c7fc857d539a6f97558e9f871d86e43783f5c78f948bd6049d8d46d06d148a7430f3e6f853  0007-don-t-fail-if-GLOB_BRACE-and-GLOB_ALTDIRFUNC-is-not-.patch
a34206eec8fc97eb3469a13b4531cee3c9e2ed170954e748db4dc53643c641b69dfede4c4ce36f440040beb36f6e091f01116335117be82353c94af8e5f8cd1f  0008-add-missing-FTW_-macros-for-musl.patch
f3046a588b0c7f1cb995f31819f6ebb0fa8da9a442fbf267a8817ead85772e99d4140773a299f17e6819e44c43034e3c13ec4e8a6941dcde824ce7aa868829f9  0010-Use-uintmax_t-for-handling-rlim_t.patch
0f02d7fd4c92bc94e616837aac25a7c06ebff1b45e3f726cf4cd0d07db670a2502cb4345304d4c47b99024d75220c3df2c8a8c94ba1d769ecbb2ebf247ef10de  0011-test-sizeof.c-Disable-tests-for-missing-typedefs-in-.patch
4bee7f5a5f517b0f3d906636d45d1a2db733a749dfd1c9b03d0ac033c3bde83e669c7ffe8f7d3b43def9a2f495231efa6d7caa93ea71ad4d577721a08ee80ebe  0014-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
e1eb4645580aeaab05c87589229d3692addff42ff132a6b5b1928b3d05280f2fce5b9f0adb2b0587fe56f75d47c5a7e83797a9b6e650ee94fd0173c28c6d6fb2  0015-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
6556a44bf013cfa37b68faec39387907bcb601f316bc056b99b8bb26c15ff373f2214fce343aa44401981837c7401bc4c5aa564d3f4321277bdd65f2e4ba5228  0018-avoid-redefinition-of-prctl_mm_map-structure.patch
9526aac2ccfa239a3fd22dcbc87b3a838ce391c84bb5ffb8d6ff2a221ac59584227ff6438906a44a81ebab74fbe53021dc208a7385906d5105d8b4d620fa60b2  0022-do-not-disable-buffer-in-writing-files.patch
5b07b3375846ac09102391a1631c98ea5f75b8a62bf70e589b7d66813a088d397f10ffc493ba0d7365b6a315ae54e4db2a00819ad11d40341f4a3925a00b624b  0025-Handle-__cpu_mask-usage.patch
1e3f85276fa22b0262220291833125907d13e3f7610fc9a38eb5e26eece532fc9f016bb73d12475d88a0bffbb9bc33c79d6ad94e85a0b167bafc9f5ecacac7ab  0026-Handle-missing-gshadow.patch
aeca4851d4cef2439eca2519dd031a842d7699782edee06239ca66f157711faf16c2943b310963faaf06d3b8c02bb0390b900ea8900c88e5ecbfc000f7929ab6  0100-Do-not-buffer-on-systemd-sleep.patch
7e2d8dd17dff530218ab6301d718d47264688ec7c4de0f57004b2a7b512f26a4ff1ab962b74f8914e410b9cc03ccf304822c5cf67b5b64fe584dc884e68fcb9e  0101-efi-do-not-set-wide-exec-charset.patch
"
